---
title: "HackTheBox - Forest Writeup"
date: 2023-03-15 12:00:00 -0500
categories: [CTF, HackTheBox]
tags: [windows, active-directory, ldap, kerberos, asreproasting, privilege-escalation]
image:
  path: /assets/img/forest/Forest.png
  alt: Forest Machine
---

# Forest

## Table of Contents
* Recon
* Service Enumeration
* Shell
* SysAdmin

## Overview

This machine is a good introduction to Windows Active Directory enumeration. It is distinct in that it doesn't contain a web server. I start off with an nmap scan to see which ports are open and what services are running. My preferred method for CTFs is:

## Recon

**nmap -A -T4 -p- ipaddress**

![nmap](/assets/img/forest/nmap.png)
*Nmap Scan Results*

There are a lot of ports open which is typical of Windows machines. After seeing the services open I turn my focus to SMB.

## Service Enumeration

### SMB Enumeration

![smb](/assets/img/forest/smb.png)
*SMB Enumeration Results*

I run smbmap to list all shares but I am not able to view anything. It's a good idea to use multiple tools when enumerating a service. There is no anonymous access so I move on. If I find credentials later I can come back to try to list the shares.

### LDAP Enumeration

I next focus on LDAP which is the second lowest hanging fruit. As we can see the Lightweight Directory Access Protocol (LDAP) is listening on a number of ports which is an indication that this is a domain controller.

![ldap with nmap](/assets/img/forest/ldap2.png)
*LDAP Enumeration with Nmap*

I like to run this nmap script for LDAP before I dive in deeper.

![ldap](/assets/img/forest/ldap.png)
*LDAP Search Results*

After enumerating with ldapsearch I get a lot of information so I save it to a file to grep out useful information. A searching shortcut for useful things to look at could be:

* `cat filename | grep -i user`
* `cat filename | grep -i memberof`
* `cat filename | grep -i description`
* `cat filename | grep -i sAMAccountName`
* `cat filename | grep -i userPrincipalName`

As you are reviewing this file look for interesting things to grep out. I found some usernames with email addresses so I will create a list:

* sebastien@htb.local
* santi@htb.local
* lucinda@htb.local
* andy@htb.local
* mark@htb.local
* Exchange_Online-ApplicationAccount@htb.local
* admin@htb.local
* administrator@htb.local

It's important to get creative with lists - add first and last names if you have them. For now I will keep searching for usernames but especially service accounts.

### RPC Enumeration

![RPC Enumeration](/assets/img/forest/rpclient.png)
*RPC Client Enumeration*

This port is relatively easy to enumerate and can generate a lot of useful information if anonymous access is allowed. We confirm the users we have from our enumeration but more importantly there is one more that wasn't in our LDAP enumeration: **svc-alfresco**! I will add this to our username list.

![RPC User Enumeration](/assets/img/forest/rpc.png)
*RPC User List*

There are many commands you can use to further enumerate this port - a useful one is `queryuser rid`.

So where do we go from here? We have enumerated all the low hanging fruit, found users, but no passwords. We could attempt to brute force SMB but we will save that as a last resort. My attention from here turns to port 88.

## Shell

### ASREPRoasting with GetNPUsers

GetNPUsers is an impacket tool that queries the target domain for users with **'Do not require Kerberos preauthentication'** set and exports their TGTs for cracking. ASREPRoasting occurs when a user account has the privilege "Does not require Pre-Authentication" set. This means that the account does not need to provide valid identification before requesting a Kerberos Ticket on the specified user account. If you have a list of users, service accounts, and port 88 open you can try this attack.

![ASREPRoasting](/assets/img/forest/getnpsusers.py.png)
*ASREPRoasting Attack*

And we have a hash! Now we can attempt to crack it.

![hash](/assets/img/forest/hash.png)
*Hash Cracking with Hashcat*

Hashcat cracks it very easily with rockyou. Now we have a password and I immediately turn to CrackMapExec. This is a great tool for enumerating services when you have multiple usernames and a password. I check to see if the credentials work for svc-alfresco.

![CME](/assets/img/forest/cmp winrm.png)
*CrackMapExec WinRM Check*

The `Pwn3d!` indicates the credentials work and we can now login with evil-winrm.

![evil-winrm](/assets/img/forest/whoami.png)
*Getting a Shell*

We have a shell!
